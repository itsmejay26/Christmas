<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magical Christmas Experience</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            min-height: 100vh;
            overflow: hidden;
            font-family: 'Georgia', serif;
            color: #fff;
        }

        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            pointer-events: none;
        }

        .scene {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 1s ease, visibility 1s ease;
        }

        .scene.active {
            opacity: 1;
            visibility: visible;
        }

        /* Scene 1 - Gift */
        #scene-gift {
            opacity: 1;
            visibility: visible;
        }

        .gift-container {
            position: relative;
            cursor: pointer;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        .gift-box {
            width: 150px;
            height: 120px;
            background: linear-gradient(145deg, #c41e3a, #8b0000);
            border-radius: 8px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.3s ease;
            box-shadow: 0 20px 60px rgba(196, 30, 58, 0.4),
                        inset 0 -10px 30px rgba(0,0,0,0.3);
        }

        .gift-container:hover .gift-box {
            transform: translateY(-10px) rotateX(5deg);
        }

        .gift-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4a, #ffd700);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .gift-lid {
            position: absolute;
            top: -30px;
            left: -10px;
            width: 170px;
            height: 35px;
            background: linear-gradient(145deg, #d42a4a, #9b1020);
            border-radius: 8px 8px 0 0;
            transform-origin: bottom center;
            transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 -5px 20px rgba(196, 30, 58, 0.3);
        }

        .gift-lid::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffed4a, #ffd700);
        }

        .gift-bow {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 40px;
        }

        .bow-loop {
            position: absolute;
            width: 35px;
            height: 25px;
            background: linear-gradient(145deg, #ffd700, #ffed4a);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
        }

        .bow-loop:first-child {
            left: -5px;
            transform: rotate(-30deg);
        }

        .bow-loop:nth-child(2) {
            right: -5px;
            transform: rotate(30deg);
        }

        .bow-center {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: linear-gradient(145deg, #ffd700, #daa520);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .gift-container.opened .gift-lid {
            transform: rotateX(-120deg) translateY(-20px);
        }

        .gift-container.opened .gift-bow {
            animation: bowFloat 1s ease forwards;
        }

        @keyframes bowFloat {
            to {
                transform: translateX(-50%) translateY(-50px) rotate(180deg);
                opacity: 0;
            }
        }

        .gift-text {
            margin-top: 40px;
            font-size: 1.4rem;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            animation: textPulse 2s ease-in-out infinite;
        }

        @keyframes textPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        /* Scene 2 - Camera */
        #scene-camera {
            flex-direction: column;
        }

        .camera-container {
            position: relative;
            width: 640px;
            max-width: 90vw;
            aspect-ratio: 4/3;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 0 60px rgba(255, 215, 0, 0.2);
        }

        #video-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            border-radius: 20px;
        }

        #hand-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transform: scaleX(-1);
        }

        .camera-instruction {
            margin-top: 30px;
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            max-width: 400px;
        }

        .emoji-tree-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transform: scaleX(-1);
        }

        /* Scene 3 - Photos */
        #scene-photos {
            perspective: 1500px;
        }

        .carousel-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            transform-style: preserve-3d;
        }

        .carousel {
            position: relative;
            width: 300px;
            height: 400px;
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
        }

        .photo-card {
            position: absolute;
            width: 280px;
            height: 380px;
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            transition: all 0.5s ease;
            overflow: hidden;
        }

        .photo-card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #ff6b6b, #ffd93d, #6bcb77, #4d96ff, #ff6b6b);
            background-size: 400% 400%;
            border-radius: 22px;
            z-index: -1;
            animation: borderGlow 4s ease infinite;
            opacity: 0.5;
        }

        .photo-card.selected::before {
            opacity: 1;
        }

        @keyframes borderGlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .photo-placeholder {
            width: 240px;
            height: 240px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .photo-title {
            font-size: 1.2rem;
            color: #fff;
            text-align: center;
        }

        .photo-instruction {
            position: absolute;
            bottom: 50px;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        /* Scene 4 - Selected Photo */
        #scene-selected {
            background: radial-gradient(ellipse at center, rgba(20, 20, 40, 0.9) 0%, rgba(0, 0, 0, 0.95) 100%);
        }

        .selected-photo-container {
            position: relative;
            transform-style: preserve-3d;
        }

        .selected-photo {
            width: 400px;
            max-width: 85vw;
            height: 500px;
            max-height: 70vh;
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border-radius: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 40px 100px rgba(255, 215, 0, 0.2),
                        0 0 100px rgba(255, 100, 100, 0.1);
            animation: selectedFloat 3s ease-in-out infinite;
        }

        @keyframes selectedFloat {
            0%, 100% { transform: translateY(0) rotateY(0deg); }
            50% { transform: translateY(-20px) rotateY(5deg); }
        }

        .selected-photo .photo-placeholder {
            width: 300px;
            height: 300px;
            font-size: 6rem;
        }

        .merry-christmas {
            margin-top: 40px;
            font-size: 2.5rem;
            background: linear-gradient(90deg, #ff6b6b, #ffd93d, #6bcb77, #ff6b6b);
            background-size: 300% 100%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: textShimmer 3s ease infinite;
            text-shadow: none;
        }

        @keyframes textShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .pinch-instruction {
            position: absolute;
            bottom: 30px;
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255, 215, 0, 0.2);
            border-top-color: #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Hand indicator */
        .hand-status {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 25px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 25px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .hand-status.detected {
            border-color: #6bcb77;
            color: #6bcb77;
        }

        @media (max-width: 768px) {
            .gift-box {
                width: 120px;
                height: 96px;
            }

            .gift-lid {
                width: 140px;
                height: 28px;
                left: -10px;
            }

            .camera-container {
                width: 95vw;
            }

            .carousel {
                width: 220px;
                height: 320px;
            }

            .photo-card {
                width: 200px;
                height: 280px;
            }

            .photo-placeholder {
                width: 160px;
                height: 160px;
                font-size: 3rem;
            }

            .merry-christmas {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <canvas id="particle-canvas"></canvas>

    <!-- Scene 1: Gift Opening -->
    <div id="scene-gift" class="scene active">
        <div class="gift-container" id="gift">
            <div class="gift-bow">
                <div class="bow-loop"></div>
                <div class="bow-loop"></div>
                <div class="bow-center"></div>
            </div>
            <div class="gift-lid"></div>
            <div class="gift-box"></div>
        </div>
        <p class="gift-text">Click the gift to open</p>
    </div>

    <!-- Scene 2: Camera & Hand Detection -->
    <div id="scene-camera" class="scene">
        <div class="hand-status" id="hand-status">Looking for hand...</div>
        <div class="camera-container">
            <video id="video-feed" autoplay playsinline></video>
            <canvas id="hand-canvas"></canvas>
            <div class="emoji-tree-container" id="emoji-tree"></div>
        </div>
        <p class="camera-instruction" id="camera-instruction">
            Open your hand to summon a magical Christmas tree! ‚ú®
        </p>
    </div>

    <!-- Scene 3: Photo Carousel -->
    <div id="scene-photos" class="scene">
        <div class="hand-status" id="photo-hand-status">Move hand to rotate</div>
        <div class="carousel-container">
            <div class="carousel" id="carousel"></div>
        </div>
        <p class="photo-instruction">Move your hand left/right to rotate. Pinch to select!</p>
    </div>

    <!-- Scene 4: Selected Photo -->
    <div id="scene-selected" class="scene">
        <div class="selected-photo-container">
            <div class="selected-photo" id="selected-photo">
                <div class="photo-placeholder" id="selected-emoji">üéÑ</div>
                <h2 class="merry-christmas">Merry Christmas!</h2>
            </div>
        </div>
        <p class="pinch-instruction">Pinch again to go back</p>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading magical experience...</p>
    </div>

    <script>
        // Particle System
        class ParticleSystem {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.particles = [];
                this.resize();
                window.addEventListener('resize', () => this.resize());
            }

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }

            createParticle(x, y, options = {}) {
                return {
                    x: x ?? Math.random() * this.canvas.width,
                    y: y ?? Math.random() * this.canvas.height,
                    vx: options.vx ?? (Math.random() - 0.5) * 2,
                    vy: options.vy ?? (Math.random() - 0.5) * 2,
                    size: options.size ?? Math.random() * 3 + 1,
                    color: options.color ?? `hsla(${Math.random() * 60 + 30}, 100%, 70%, ${Math.random() * 0.5 + 0.3})`,
                    life: options.life ?? 1,
                    decay: options.decay ?? 0.005,
                    type: options.type ?? 'dust'
                };
            }

            addAmbientParticles(count = 50) {
                for (let i = 0; i < count; i++) {
                    this.particles.push(this.createParticle(null, null, {
                        vx: (Math.random() - 0.5) * 0.5,
                        vy: (Math.random() - 0.5) * 0.5,
                        decay: 0,
                        type: 'ambient'
                    }));
                }
            }

            addBurstParticles(x, y, count = 100) {
                for (let i = 0; i < count; i++) {
                    const angle = (Math.PI * 2 / count) * i + Math.random() * 0.5;
                    const speed = Math.random() * 8 + 2;
                    this.particles.push(this.createParticle(x, y, {
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        size: Math.random() * 4 + 2,
                        color: `hsla(${Math.random() * 60 + 10}, 100%, 60%, 0.8)`,
                        decay: 0.015,
                        type: 'burst'
                    }));
                }
            }

            addSnowParticles(count = 30) {
                for (let i = 0; i < count; i++) {
                    this.particles.push(this.createParticle(Math.random() * this.canvas.width, -10, {
                        vx: (Math.random() - 0.5) * 1,
                        vy: Math.random() * 2 + 1,
                        size: Math.random() * 4 + 2,
                        color: `rgba(255, 255, 255, ${Math.random() * 0.6 + 0.4})`,
                        decay: 0,
                        type: 'snow'
                    }));
                }
            }

            addStarParticles(x, y, count = 20) {
                for (let i = 0; i < count; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = Math.random() * 3 + 1;
                    this.particles.push(this.createParticle(x, y, {
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed,
                        size: Math.random() * 3 + 2,
                        color: `hsla(${Math.random() * 40 + 40}, 100%, 70%, 0.9)`,
                        decay: 0.02,
                        type: 'star'
                    }));
                }
            }

            update() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const p = this.particles[i];
                    
                    p.x += p.vx;
                    p.y += p.vy;
                    
                    if (p.type === 'burst') {
                        p.vx *= 0.98;
                        p.vy *= 0.98;
                    }
                    
                    if (p.type === 'snow') {
                        p.vx += (Math.random() - 0.5) * 0.1;
                        if (p.y > this.canvas.height) {
                            p.y = -10;
                            p.x = Math.random() * this.canvas.width;
                        }
                    }
                    
                    if (p.type === 'ambient') {
                        if (p.x < 0 || p.x > this.canvas.width) p.vx *= -1;
                        if (p.y < 0 || p.y > this.canvas.height) p.vy *= -1;
                    }

                    p.life -= p.decay;

                    if (p.life <= 0 && p.type !== 'ambient' && p.type !== 'snow') {
                        this.particles.splice(i, 1);
                        continue;
                    }

                    this.ctx.beginPath();
                    this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    
                    if (p.type === 'star') {
                        this.ctx.shadowBlur = 15;
                        this.ctx.shadowColor = p.color;
                    } else {
                        this.ctx.shadowBlur = 10;
                        this.ctx.shadowColor = p.color;
                    }
                    
                    this.ctx.fillStyle = p.color.replace(/[\d.]+\)$/, `${p.life})`);
                    this.ctx.fill();
                }

                this.ctx.shadowBlur = 0;
            }

            clear() {
                this.particles = this.particles.filter(p => p.type === 'ambient' || p.type === 'snow');
            }
        }

        // Main Application
        class ChristmasExperience {
            constructor() {
                this.currentScene = 'gift';
                this.particleSystem = new ParticleSystem(document.getElementById('particle-canvas'));
                this.hands = null;
                this.camera = null;
                this.handDetected = false;
                this.handOpen = false;
                this.prevHandOpen = false;
                this.treeVisible = false;
                this.emojiParticles = [];
                this.carouselAngle = 0;
                this.selectedPhotoIndex = 0;
                this.pinchActive = false;
                this.prevPinchActive = false;
                this.handX = 0.5;
                
                this.photos = [
                    { emoji: 'üéÑ', title: 'Christmas Tree' },
                    { emoji: 'üéÖ', title: 'Santa Claus' },
                    { emoji: '‚õÑ', title: 'Snowman' },
                    { emoji: 'ü¶å', title: 'Reindeer' },
                    { emoji: 'üéÅ', title: 'Gift' }
                ];

                this.init();
            }

            async init() {
                this.particleSystem.addAmbientParticles(30);
                this.setupGiftScene();
                this.animate();
                
                setTimeout(() => {
                    document.getElementById('loading').classList.add('hidden');
                }, 1000);
            }

            setupGiftScene() {
                const gift = document.getElementById('gift');
                gift.addEventListener('click', () => this.openGift());
            }

            openGift() {
                const gift = document.getElementById('gift');
                if (gift.classList.contains('opened')) return;
                
                gift.classList.add('opened');
                
                const rect = gift.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                this.particleSystem.addBurstParticles(centerX, centerY, 150);
                
                setTimeout(() => {
                    for (let i = 0; i < 5; i++) {
                        setTimeout(() => {
                            this.particleSystem.addStarParticles(
                                centerX + (Math.random() - 0.5) * 100,
                                centerY + (Math.random() - 0.5) * 100,
                                15
                            );
                        }, i * 100);
                    }
                }, 300);
                
                setTimeout(() => {
                    this.transitionToScene('camera');
                }, 1500);
            }

            async transitionToScene(sceneName) {
                const currentSceneEl = document.querySelector('.scene.active');
                currentSceneEl.classList.remove('active');
                
                await new Promise(r => setTimeout(r, 500));
                
                const newSceneEl = document.getElementById(`scene-${sceneName}`);
                newSceneEl.classList.add('active');
                this.currentScene = sceneName;
                
                if (sceneName === 'camera') {
                    await this.setupCameraScene();
                } else if (sceneName === 'photos') {
                    this.setupPhotoScene();
                } else if (sceneName === 'selected') {
                    this.setupSelectedScene();
                }
            }

            async setupCameraScene() {
                try {
                    const video = document.getElementById('video-feed');
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'user', width: 640, height: 480 } 
                    });
                    video.srcObject = stream;
                    
                    await this.initHandTracking();
                } catch (err) {
                    console.error('Camera error:', err);
                    document.getElementById('camera-instruction').textContent = 
                        'Camera access needed. Please allow camera access and refresh.';
                }
            }

            async initHandTracking() {
                const hands = new Hands({
                    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
                });
                
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.7,
                    minTrackingConfidence: 0.5
                });
                
                hands.onResults((results) => this.onHandResults(results));
                
                const video = document.getElementById('video-feed');
                const camera = new Camera(video, {
                    onFrame: async () => {
                        await hands.send({ image: video });
                    },
                    width: 640,
                    height: 480
                });
                
                camera.start();
                this.hands = hands;
                this.camera = camera;
            }

            onHandResults(results) {
                const handCanvas = document.getElementById('hand-canvas');
                const ctx = handCanvas.getContext('2d');
                handCanvas.width = 640;
                handCanvas.height = 480;
                ctx.clearRect(0, 0, handCanvas.width, handCanvas.height);
                
                const statusEl = document.getElementById('hand-status');
                const photoStatusEl = document.getElementById('photo-hand-status');
                
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const landmarks = results.multiHandLandmarks[0];
                    this.handDetected = true;
                    
                    if (statusEl) {
                        statusEl.textContent = 'Hand detected! ‚úã';
                        statusEl.classList.add('detected');
                    }
                    if (photoStatusEl) {
                        photoStatusEl.textContent = 'Hand detected! ‚úã';
                        photoStatusEl.classList.add('detected');
                    }
                    
                    // Draw hand landmarks
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.8)';
                    for (const landmark of landmarks) {
                        ctx.beginPath();
                        ctx.arc(landmark.x * handCanvas.width, landmark.y * handCanvas.height, 5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    // Connect landmarks
                    ctx.strokeStyle = 'rgba(255, 215, 0, 0.5)';
                    ctx.lineWidth = 2;
                    const connections = [
                        [0, 1], [1, 2], [2, 3], [3, 4],
                        [0, 5], [5, 6], [6, 7], [7, 8],
                        [0, 9], [9, 10], [10, 11], [11, 12],
                        [0, 13], [13, 14], [14, 15], [15, 16],
                        [0, 17], [17, 18], [18, 19], [19, 20],
                        [5, 9], [9, 13], [13, 17]
                    ];
                    
                    for (const [i, j] of connections) {
                        ctx.beginPath();
                        ctx.moveTo(landmarks[i].x * handCanvas.width, landmarks[i].y * handCanvas.height);
                        ctx.lineTo(landmarks[j].x * handCanvas.width, landmarks[j].y * handCanvas.height);
                        ctx.stroke();
                    }
                    
                    // Detect hand open/closed
                    const palmBase = landmarks[0];
                    const middleTip = landmarks[12];
                    const indexTip = landmarks[8];
                    const ringTip = landmarks[16];
                    const pinkyTip = landmarks[20];
                    
                    const avgFingerDist = (
                        this.distance(palmBase, middleTip) +
                        this.distance(palmBase, indexTip) +
                        this.distance(palmBase, ringTip) +
                        this.distance(palmBase, pinkyTip)
                    ) / 4;
                    
                    this.prevHandOpen = this.handOpen;
                    this.handOpen = avgFingerDist > 0.25;
                    
                    // Detect pinch
                    const thumbTip = landmarks[4];
                    const pinchDist = this.distance(thumbTip, indexTip);
                    this.prevPinchActive = this.pinchActive;
                    this.pinchActive = pinchDist < 0.08;
                    
                    // Track hand X position for carousel
                    this.handX = landmarks[9].x;
                    
                    // Handle scene-specific logic
                    if (this.currentScene === 'camera') {
                        this.handleCameraHandLogic(landmarks);
                    } else if (this.currentScene === 'photos') {
                        this.handlePhotoHandLogic();
                    } else if (this.currentScene === 'selected') {
                        this.handleSelectedHandLogic();
                    }
                    
                } else {
                    this.handDetected = false;
                    if (statusEl) {
                        statusEl.textContent = 'Looking for hand...';
                        statusEl.classList.remove('detected');
                    }
                    if (photoStatusEl) {
                        photoStatusEl.textContent = 'Looking for hand...';
                        photoStatusEl.classList.remove('detected');
                    }
                }
            }

            distance(p1, p2) {
                return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
            }

            handleCameraHandLogic(landmarks) {
                const instruction = document.getElementById('camera-instruction');
                
                if (this.handOpen && !this.prevHandOpen) {
                    if (!this.treeVisible) {
                        this.showEmojiTree(landmarks[9]);
                        instruction.textContent = 'Beautiful! Close your hand to disperse the tree.';
                    }
                } else if (!this.handOpen && this.prevHandOpen && this.treeVisible) {
                    this.disperseEmojiTree();
                    instruction.textContent = 'Magical! Moving to photo gallery...';
                    setTimeout(() => {
                        this.transitionToScene('photos');
                    }, 2000);
                }
            }

            showEmojiTree(palmCenter) {
                this.treeVisible = true;
                const container = document.getElementById('emoji-tree');
                container.innerHTML = '';
                
                const treeEmojis = ['üéÑ', '‚≠ê', 'üéÅ', 'üîî', '‚ùÑÔ∏è', '‚ú®', 'üéÄ', 'üåü'];
                const rows = 7;
                
                for (let row = 0; row < rows; row++) {
                    const emojisInRow = row + 1;
                    for (let col = 0; col < emojisInRow; col++) {
                        const emoji = document.createElement('div');
                        emoji.style.cssText = `
                            position: absolute;
                            font-size: ${24 - row * 2}px;
                            opacity: 0;
                            transition: all 0.5s ease;
                            transform: scale(0);
                            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
                        `;
                        
                        const startX = palmCenter.x * 640;
                        const startY = palmCenter.y * 480;
                        
                        const finalX = startX - (emojisInRow * 15) / 2 + col * 30;
                        const finalY = startY - 200 + row * 30;
                        
                        emoji.textContent = row === 0 ? '‚≠ê' : treeEmojis[Math.floor(Math.random() * treeEmojis.length)];
                        emoji.style.left = `${startX}px`;
                        emoji.style.top = `${startY}px`;
                        
                        container.appendChild(emoji);
                        
                        setTimeout(() => {
                            emoji.style.opacity = '1';
                            emoji.style.transform = 'scale(1)';
                            emoji.style.left = `${finalX}px`;
                            emoji.style.top = `${finalY}px`;
                        }, (row * emojisInRow + col) * 50);
                        
                        this.emojiParticles.push({ element: emoji, finalX, finalY });
                    }
                }
            }

            disperseEmojiTree() {
                this.treeVisible = false;
                
                for (const particle of this.emojiParticles) {
                    const randX = (Math.random() - 0.5) * 800;
                    const randY = (Math.random() - 0.5) * 800;
                    
                    particle.element.style.transition = 'all 1s ease-out';
                    particle.element.style.left = `${particle.finalX + randX}px`;
                    particle.element.style.top = `${particle.finalY + randY}px`;
                    particle.element.style.opacity = '0';
                    particle.element.style.transform = 'scale(0) rotate(360deg)';
                }
                
                // Add particle burst
                this.particleSystem.addBurstParticles(window.innerWidth / 2, window.innerHeight / 2, 100);
                
                setTimeout(() => {
                    document.getElementById('emoji-tree').innerHTML = '';
                    this.emojiParticles = [];
                }, 1000);
            }

            setupPhotoScene() {
                const carousel = document.getElementById('carousel');
                carousel.innerHTML = '';
                
                this.photos.forEach((photo, index) => {
                    const card = document.createElement('div');
                    card.className = 'photo-card';
                    card.innerHTML = `
                        <div class="photo-placeholder">${photo.emoji}</div>
                        <p class="photo-title">${photo.title}</p>
                    `;
                    
                    const angle = (360 / this.photos.length) * index;
                    card.style.transform = `rotateY(${angle}deg) translateZ(300px)`;
                    
                    carousel.appendChild(card);
                });
                
                this.particleSystem.addSnowParticles(50);
            }

            handlePhotoHandLogic() {
                // Rotate carousel based on hand position
                const targetAngle = (this.handX - 0.5) * -360;
                this.carouselAngle += (targetAngle - this.carouselAngle) * 0.1;
                
                const carousel = document.getElementById('carousel');
                carousel.style.transform = `rotateY(${this.carouselAngle}deg)`;
                
                // Determine selected photo
                const normalizedAngle = ((this.carouselAngle % 360) + 360) % 360;
                this.selectedPhotoIndex = Math.round(normalizedAngle / (360 / this.photos.length)) % this.photos.length;
                
                // Highlight selected
                const cards = carousel.querySelectorAll('.photo-card');
                cards.forEach((card, index) => {
                    card.classList.toggle('selected', index === this.selectedPhotoIndex);
                });
                
                // Handle pinch to select
                if (this.pinchActive && !this.prevPinchActive) {
                    this.transitionToScene('selected');
                }
            }

            setupSelectedScene() {
                const photo = this.photos[this.selectedPhotoIndex];
                document.getElementById('selected-emoji').textContent = photo.emoji;
                
                // Add festive particles
                this.particleSystem.addSnowParticles(100);
                
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                
                for (let i = 0; i < 10; i++) {
                    setTimeout(() => {
                        this.particleSystem.addStarParticles(
                            centerX + (Math.random() - 0.5) * 400,
                            centerY + (Math.random() - 0.5) * 400,
                            20
                        );
                    }, i * 200);
                }
            }

            handleSelectedHandLogic() {
                if (this.pinchActive && !this.prevPinchActive) {
                    this.transitionToScene('photos');
                }
            }

            animate() {
                this.particleSystem.update();
                
                // Add continuous snow in later scenes
                if ((this.currentScene === 'photos' || this.currentScene === 'selected') && Math.random() < 0.1) {
                    this.particleSystem.addSnowParticles(2);
                }
                
                requestAnimationFrame(() => this.animate());
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            new ChristmasExperience();
        });
    </script>
</body>
</html>